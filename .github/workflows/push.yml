name: Push image to ECR

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop, master ]

jobs:

  push-to-ecr:
    name: Push Image
    runs-on: ubuntu-latest
    environment: production

    # This check needs to be in place to prevent a publish loop with auto and github actions
    if: "contains(github.event.head_commit.message, 'ci build') || contains(github.event.head_commit.message, 'build ci') || contains(github.ref_name, 'master') || contains(github.ref_name, 'develop')"
    

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Extract branch name
        shell: bash
        run: |
          BRANCH=$(echo ${{ github.event.client_payload.branch }})
          if [ "$BRANCH" = "master" ]; then
              TAG="latest"
          else
              TAG="$BRANCH"
          fi
          echo "##[set-output name=tag;]$TAG"
        id: extract_branch

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: unguess-api
          IMAGE_TAG: ${{ steps.extract_branch.outputs.tag }}
        run: |
            # Build a docker container and
            # push it to ECR so that it can
            # be deployed to ECS.
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"